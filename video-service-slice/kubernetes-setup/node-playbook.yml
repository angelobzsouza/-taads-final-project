---
- hosts: all
  tasks:
    - name: Remove swapfile from /etc/fstab
      mount:
        name: "{{ item }}"
        fstype: swap
        state: absent
      with_items:
        - swap
        - none
      become: yes

    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0
      become: yes

    - name: Add an apt signing key for Kubernetes
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present
      become: yes

    - name: Adding apt repository for Kubernetes
      apt_repository:
        repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
        state: present
        filename: kubernetes.list
      become: yes

    - name: Atualiza a lista de repositorios e instala os pacotes do K8s
      apt: name={{ item }} update_cache=yes
      loop: ['kubelet', 'kubeadm', 'kubectl']
      become: yes

    - name: Acessa o cluster utilizando o token gerado pelo master
      command: sh /vagrant/video-service-slice/kubernetes-setup/join-command.sh
      become: yes

    - name: Configura iptables para conexao dos nodes
      command: echo "net.bridge.bridge-nf-call-iptables=1" | tee -a /etc/sysctl.conf
      become: yes

    # - name: Copia arquivo de configuracao flannel e arruma as permissoes
    #   command: "{{ item }}"
    #   with_items:
    #     - cp /vagrant/video-service-slice/kubernetes-setup/subnet.env /run/flannel/
    #     - chown root:root /run/flannel/subnet.env
    #     - chmod 644 /run/flannel/subnet.env
    #   become: yes

    # - name: Adiciona arquivo de configuracao
    #   copy:
    #     src: /vagrant/video-service-slice/kubernetes-setup/subnet.env
    #     dest: /run/flannel/subnet.env
    #     owner: root
    #     group: root
    #     mode: '0644'
    #   become: yes
